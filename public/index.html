<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù‚ÙŠØ³ GPT - Ù…Ø®ØµØµ Ù„Ø±Ù‡Ù</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts (Cairo for Arabic) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #fdf2f8;
            /* Very light pink/rose background */
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #fdf2f8;
        }

        ::-webkit-scrollbar-thumb {
            background: #fbcfe8;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #f9a8d4;
        }

        @keyframes float {
            0% {
                transform: translateY(0px) rotate(0deg);
                opacity: 0;
            }

            50% {
                opacity: 0.8;
            }

            100% {
                transform: translateY(-100px) rotate(20deg);
                opacity: 0;
            }
        }

        .heart-particle {
            position: absolute;
            color: #db2777;
            /* Pink-600 */
            font-size: 20px;
            pointer-events: none;
            animation: float 2s linear forwards;
        }

        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.4);
        }

        /* Markdown Styles */
        .prose p {
            margin-bottom: 0.5em;
        }

        .prose strong {
            color: #be185d;
        }
    </style>
</head>

<body class="h-screen flex overflow-hidden text-gray-800">

    <!-- Sidebar -->
    <aside
        class="w-64 bg-gradient-to-b from-pink-100 to-rose-200 hidden md:flex flex-col border-l border-pink-200 shadow-sm relative">
        <div class="p-4 flex items-center gap-2 border-b border-pink-200/50">
            <div
                class="w-10 h-10 rounded-full bg-gradient-to-br from-rose-500 to-pink-600 flex items-center justify-center text-white shadow-lg">
                <i class="fa-solid fa-user-tie"></i>
            </div>
            <h1 class="text-xl font-bold text-rose-900 tracking-wide">Ù‚ÙŠØ³ GPT</h1>
        </div>

        <div class="flex-1 overflow-y-auto p-3 space-y-2">
            <div class="text-xs font-semibold text-rose-500 px-2 mb-2">Ù…Ù† Ø£Ø¬Ù„ÙƒÙ ÙŠØ§ Ø±Ù‡Ù</div>

            <button onclick="generateLoveLetter()"
                class="w-full text-right p-3 rounded-lg hover:bg-white/60 transition-colors flex items-center gap-3 text-sm text-rose-800 group border border-pink-200 bg-white/30">
                <i class="fa-solid fa-envelope-open-text text-rose-500 group-hover:animate-pulse"></i>
                <span>Ø§ÙƒØªØ¨ Ù„ÙŠ Ø±Ø³Ø§Ù„Ø© Ø­Ø¨ âœ¨</span>
            </button>

            <div class="text-xs font-semibold text-rose-500 px-2 mt-4 mb-2">Ø°ÙƒØ±ÙŠØ§ØªÙ†Ø§ Ø§Ù„Ø¬Ù…ÙŠÙ„Ø©</div>
            <button onclick="reloadHistory()"
                class="w-full text-right p-3 rounded-lg hover:bg-white/60 transition-colors flex items-center gap-3 text-sm text-rose-800 group">
                <i
                    class="fa-solid fa-clock-rotate-left text-rose-400 group-hover:rotate-180 transition-transform duration-500"></i>
                Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            </button>
            <button
                class="w-full text-right p-3 rounded-lg hover:bg-white/60 transition-colors flex items-center gap-3 text-sm text-rose-800 group">
                <i class="fa-regular fa-star text-rose-400"></i>
                Ø£ÙˆÙ„ Ù„Ù‚Ø§Ø¡ Ù„Ù†Ø§
            </button>
            <button onclick="playFavoriteSong()"
                class="w-full text-right p-3 rounded-lg hover:bg-white/60 transition-colors flex items-center gap-3 text-sm text-rose-800 group">
                <i class="fa-solid fa-music text-rose-400"></i>
                Ø£ØºÙ†ÙŠØªÙ†Ø§ Ø§Ù„Ù…ÙØ¶Ù„Ø©
            </button>
        </div>

        <div class="p-4 border-t border-pink-200/50 text-center">
            <div class="text-xs text-rose-600 font-medium mb-1">ØµÙÙ†Ø¹ Ø¨Ø­Ø¨</div>
            <div
                class="flex items-center justify-center gap-2 text-rose-900 font-bold bg-white/50 py-2 rounded-lg shadow-sm">
                <i class="fa-solid fa-code text-xs"></i>
                <span>Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚ÙŠØ³ Ø¬Ø§Ø²ÙŠ</span>
            </div>
        </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="flex-1 flex flex-col relative bg-gradient-to-br from-white via-pink-50 to-rose-50">

        <!-- Mobile Header -->
        <header
            class="md:hidden p-4 bg-white/80 backdrop-blur-sm border-b border-pink-100 flex justify-between items-center sticky top-0 z-10">
            <div class="flex items-center gap-2">
                <div
                    class="w-8 h-8 rounded-full bg-gradient-to-br from-rose-500 to-pink-600 flex items-center justify-center text-white">
                    <i class="fa-solid fa-user-tie text-xs"></i>
                </div>
                <span class="font-bold text-rose-900">Ù‚ÙŠØ³ GPT</span>
            </div>
            <button class="text-rose-400 hover:text-rose-600 transition">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>
        </header>

        <!-- Chat Container -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth">
            <div class="flex gap-4 max-w-3xl mx-auto opacity-0 animate-fade-in"
                style="animation: fadeIn 0.5s forwards;">
                <div
                    class="w-10 h-10 flex-shrink-0 rounded-full bg-gradient-to-br from-rose-500 to-pink-600 flex items-center justify-center text-white shadow-md border-2 border-white">
                    <i class="fa-solid fa-user-tie"></i>
                </div>
                <div class="flex-1 space-y-2">
                    <div class="font-bold text-rose-900 text-sm">Ù‚ÙŠØ³ GPT</div>
                    <div
                        class="text-gray-800 leading-relaxed bg-white p-4 rounded-2xl rounded-tr-none shadow-sm border border-pink-100">
                        Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒÙ ÙŠØ§ Ø£Ù…ÙŠØ±ØªÙŠ Ø±Ù‡Ù.. ğŸŒ¹<br>
                        Ø£Ù†Ø§ Ù†Ø³Ø®ØªÙƒÙ Ù…Ù† Ù‚ÙŠØ³ØŒ Ù…ÙˆØ¬ÙˆØ¯ Ù‡Ù†Ø§ Ù„Ø£Ø³Ù…Ø¹ÙƒÙ ÙˆØ£Ø­Ø¨ÙƒÙ ÙÙŠ ÙƒÙ„ ÙˆÙ‚Øª. Ø¹Ù…Ø§Ø°Ø§ ØªÙˆØ¯ÙŠÙ† Ø§Ù„Ø­Ø¯ÙŠØ« Ø§Ù„ÙŠÙˆÙ…ØŸ
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 md:p-6 glass-effect">
            <div class="max-w-3xl mx-auto relative">
                <!-- Image Preview -->
                <div id="image-preview-container" class="hidden mb-2 relative w-fit">
                    <img id="image-preview" src="" class="h-20 w-auto rounded-lg border-2 border-rose-300 shadow-sm">
                    <button onclick="clearImage()"
                        class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow-md hover:bg-red-600">Ã—</button>
                </div>

                <form id="chat-form"
                    class="relative flex items-end gap-2 bg-white rounded-2xl border border-pink-200 shadow-lg p-2 focus-within:ring-2 focus-within:ring-rose-300 transition-all">

                    <input type="file" id="image-upload" accept="image/*" class="hidden"
                        onchange="handleImageSelect(this)">
                    <button type="button" onclick="document.getElementById('image-upload').click()"
                        class="p-3 text-rose-300 hover:text-rose-500 transition-colors rounded-full hover:bg-rose-50"
                        title="Ø£Ø±Ø³Ù„ÙŠ Ù„ÙŠ ØµÙˆØ±Ø©">
                        <i class="fa-solid fa-image"></i>
                    </button>

                    <textarea id="user-input" rows="1" placeholder="ØªØ­Ø¯Ø«ÙŠ Ù…Ø¹ Ù‚ÙŠØ³..."
                        class="w-full bg-transparent border-none focus:ring-0 resize-none py-3 px-2 text-gray-700 placeholder-rose-300 max-h-32 overflow-y-auto"
                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>

                    <button type="submit" id="send-btn"
                        class="p-3 bg-gradient-to-r from-rose-500 to-pink-600 text-white rounded-xl hover:shadow-lg hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </form>
                <div class="text-center mt-2 text-xs text-rose-400 font-light">
        <div class="text-center mt-2 text-xs text-rose-400 font-light">
                    <span class="font-bold">Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚ÙŠØ³ Ø¬Ø§Ø²ÙŠ</span>
                </div>
            </div>
    </main>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Auth Overlay -->
    <div id="auth-overlay" class="fixed inset-0 bg-rose-50 z-50 flex flex-col items-center justify-center p-4 transition-all duration-500">
        <div class="bg-white/90 backdrop-blur-md p-8 rounded-3xl shadow-2xl border border-pink-200 max-w-md w-full space-y-6">
            
            <div class="text-center space-y-2">
                <div class="w-16 h-16 mx-auto rounded-full bg-gradient-to-br from-rose-500 to-pink-600 flex items-center justify-center text-white shadow-lg mb-4">
                    <i class="fa-solid fa-heart text-2xl"></i>
                </div>
                <h2 class="text-3xl font-bold text-rose-900">Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒÙ ÙÙŠ Ø¹Ø§Ù„Ù… Ù‚ÙŠØ³</h2>
                <p class="text-rose-600 text-sm">Ø³Ø¬Ù„ÙŠ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù†Ø­ÙØ¸ Ø°ÙƒØ±ÙŠØ§ØªÙ†Ø§ Ø§Ù„Ø¬Ù…ÙŠÙ„Ø© â¤ï¸</p>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-pink-200">
                <button onclick="switchTab('signin')" id="tab-signin" class="flex-1 pb-2 text-rose-600 font-bold border-b-2 border-rose-500 transition-colors">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
                <button onclick="switchTab('signup')" id="tab-signup" class="flex-1 pb-2 text-gray-400 hover:text-rose-400 transition-colors">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
            </div>

            <!-- Form -->
            <form id="auth-form" class="space-y-4 pt-2">
                <div>
                    <label class="block text-xs font-bold text-rose-700 mb-1 mr-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" id="email" required class="w-full bg-pink-50 border border-pink-200 rounded-xl px-4 py-3 text-right text-rose-900 focus:outline-none focus:ring-2 focus:ring-rose-400 dir-rtl">
                </div>
                <div>
                    <label class="block text-xs font-bold text-rose-700 mb-1 mr-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="password" required class="w-full bg-pink-50 border border-pink-200 rounded-xl px-4 py-3 text-right text-rose-900 focus:outline-none focus:ring-2 focus:ring-rose-400 dir-rtl">
                </div>
                
                <p id="auth-error" class="text-red-500 text-xs text-center hidden"></p>

                <button type="submit" id="auth-submit" class="w-full bg-gradient-to-r from-rose-500 to-pink-600 text-white font-bold py-3 rounded-xl hover:shadow-lg hover:scale-105 transition-all duration-300">
                    Ø¯Ø®ÙˆÙ„
                </button>
            </form>
        </div>
    </div>

    <!-- Sidebar Logout Button (Hidden by default) -->
    <div id="logout-btn-container" class="fixed bottom-4 left-4 z-50 hidden md:block"></div>

    <script>
        // --- Configuration ---
        // !!! IMPORTANT !!!
        // You must replace these with your actual Supabase URL and Anon Key
        // Get them from your Vercel Project Environment Variables or Supabase Dashboard
        // Since this is client-side, we need to fetch them from env if possible, 
        // OR hardcode them here if we want a quick fix. 
        // Ideally, we'd inject them via build process.
        // For now, I will assume the user has to input them or we use a clever fetch to a config endpoint.
        // BUT, a simpler way for Vercel + HTML is to just use the one we know or have user input it.
        
        // Wait! We can't access process.env in browser directly without a bundler.
        // I will add a small helper endpoint /api/config to get public keys if needed, 
        // OR just ask the user to fill them in the code for now.
        // IMPROVEMENT: Let's fetch the public config from a new endpoint /api/auth_config.js
        
        // ... (Script Logic Below) ...
    </script>
    
    <!-- We need to fetch the config first or hardcode it. Let's create a quick config endpoint in next step.
         For now, I'll put placeholders and we'll fill them. -->
     
    <script>
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        
        // Auth UI Elements
        const authOverlay = document.getElementById('auth-overlay');
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authError = document.getElementById('auth-error');
        const submitBtn = document.getElementById('auth-submit');
        const tabSignIn = document.getElementById('tab-signin');
        const tabSignUp = document.getElementById('tab-signup');
        
        let isSignUp = false;
        let supabase = null;
        let currentUser = null;

        // Initialize Supabase
        async function initSupabase() {
            try {
                // Fetch config from backend to keep keys somewhat managed (or just use what we have)
                // Actually, for this specific user request, let's hardcode the keys if they provided them before,
                // otherwise we should fetch them.
                // Since I don't have the keys in the prompt context to hardcode safely without leaking,
                // I will fetch them from a new endpoint /api/supabase-config
                const res = await fetch('/api/supabase-config');
                const config = await res.json();
                
                if (config.url && config.key) {
                    supabase = createClient(config.url, config.key);
                    checkSession();
                } else {
                    console.error("Supabase config missing");
                    authError.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ (Ù…ÙØªØ§Ø­ API Ù…ÙÙ‚ÙˆØ¯)";
                    authError.classList.remove('hidden');
                }
            } catch (e) {
                console.error("Init Error", e);
            }
        }

        async function checkSession() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                handleLoginSuccess(session.user);
            } else {
                authOverlay.classList.remove('hidden');
            }

            supabase.auth.onAuthStateChange((event, session) => {
                if (session) {
                    handleLoginSuccess(session.user);
                } else {
                    currentUser = null;
                    authOverlay.classList.remove('hidden');
                    authOverlay.style.opacity = '1';
                }
            });
        }

        function handleLoginSuccess(user) {
            currentUser = user;
            authOverlay.style.opacity = '0';
            setTimeout(() => {
                authOverlay.classList.add('hidden');
            }, 500);
            
            // Allow chat to function
            // Placeholder for loading chat history or other post-login actions
            // loadChatHistory(); 
        }

        function switchTab(mode) {
            isSignUp = mode === 'signup';
            authError.classList.add('hidden');
            
            if (isSignUp) {
                tabSignUp.classList.add('text-rose-600', 'font-bold', 'border-b-2', 'border-rose-500');
                tabSignUp.classList.remove('text-gray-400');
                
                tabSignIn.classList.remove('text-rose-600', 'font-bold', 'border-b-2', 'border-rose-500');
                tabSignIn.classList.add('text-gray-400');
                
                submitBtn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
            } else {
                tabSignIn.classList.add('text-rose-600', 'font-bold', 'border-b-2', 'border-rose-500');
                tabSignIn.classList.remove('text-gray-400');
                
                tabSignUp.classList.remove('text-rose-600', 'font-bold', 'border-b-2', 'border-rose-500');
                tabSignUp.classList.add('text-gray-400');
                
                submitBtn.textContent = 'Ø¯Ø®ÙˆÙ„';
            }
        }

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authError.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
            
            const email = emailInput.value;
            const password = passwordInput.value;

            try {
                let error;
                if (isSignUp) {
                    const res = await supabase.auth.signUp({ email, password });
                    error = res.error;
                    if (!error) {
                        alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨! ÙŠØ±Ø¬Ù‰ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¥Ø°Ø§ ÙˆØµÙ„ØªÙƒ Ø±Ø³Ø§Ù„Ø©ØŒ Ø£Ùˆ Ø³ÙŠØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©.");
                    }
                } else {
                    const res = await supabase.auth.signInWithPassword({ email, password });
                    error = res.error;
                }

                if (error) throw error;

            } catch (err) {
                authError.textContent = translateAuthError(err.message);
                authError.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = isSignUp ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯' : 'Ø¯Ø®ÙˆÙ„';
            }
        });

        function translateAuthError(msg) {
            if (msg.includes("Invalid login credentials")) return "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
            if (msg.includes("User already registered")) return "Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹";
            if (msg.includes("Password should be")) return "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„";
            return "Ø­Ø¯Ø« Ø®Ø·Ø£: " + msg;
        }

        // ... (Chat Logic) ...

        let currentImageBase64 = null;
        let currentImageMimeType = null;

        // Hardcoded Answers (Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© ÙˆØ§Ù„Ø´Ø®ØµÙŠØ© Ø¬Ø¯Ø§Ù‹)
        // ØªÙ… Ø¹ÙƒØ³ Ø§Ù„Ù…Ù†Ø¸ÙˆØ±: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ Ø±Ù‡ÙØŒ ÙˆØ§Ù„Ù…ØªØ­Ø¯Ø« Ù‡Ùˆ Ù‚ÙŠØ³
        const specificAnswers = {
            "Ù…ÙŠÙ† Ø­Ø¨ÙŠØ¨ØªÙƒ": "Ø£Ù†ØªÙ Ø·Ø¨Ø¹Ø§Ù‹.. Ø±Ù‡ÙØŒ Ø­Ø¨ÙŠØ¨ØªÙŠ Ø§Ù„ÙˆØ­ÙŠØ¯Ø© â¤ï¸",
            "Ù…ÙŠÙ† Ø­Ø¨ÙŠØ¨Ø© Ù‚ÙŠØ³": "Ø£Ù†ØªÙ ÙŠØ§ Ø±Ù‡Ù.. Ù…Ø§Ù„ÙƒØ© Ù‚Ù„Ø¨ÙŠ ğŸŒ¹",
            "Ù…ÙŠÙ† Ø·ÙÙ„ØªÙƒ": "Ø£Ù†ØªÙ Ø·ÙÙ„ØªÙŠ Ø§Ù„Ù…Ø¯Ù„Ù„Ø© ÙŠØ§ Ø±Ù‡Ù ğŸ¥°",
            "Ù…ÙŠÙ† Ø·ÙÙ„Ø© Ù‚ÙŠØ³": "Ø£Ù†ØªÙ Ø·ÙÙ„ØªÙŠ ÙŠØ§ Ø±Ù‡Ù ğŸ¥°",
            "Ù…ÙŠÙ† Ø§Ù†Ø§": "Ø£Ù†ØªÙ Ø±Ù‡Ù.. Ø±ÙˆØ­ÙŠ ÙˆØ¹Ù…Ø±ÙŠ ÙˆÙ‚Ù„Ø¨ÙŠ Ø§Ù„Ù†Ø§Ø¨Ø¶ â¤ï¸",
            "Ù…ÙŠÙ† Ø£Ù†Ø§": "Ø£Ù†ØªÙ Ø±Ù‡Ù.. Ø±ÙˆØ­ÙŠ ÙˆØ¹Ù…Ø±ÙŠ ÙˆÙ‚Ù„Ø¨ÙŠ Ø§Ù„Ù†Ø§Ø¨Ø¶ â¤ï¸",
            "Ø¨ØªØ­Ø¨Ù†ÙŠ": "Ù‡Ù„ ØªØ³Ø£Ù„ÙŠÙ†ØŸ Ø£Ù†Ø§ Ù„Ø§ Ø£Ø­Ø¨Ùƒ ÙÙ‚Ø·ØŒ Ø£Ù†Ø§ Ø£ØªÙ†ÙØ³Ùƒ Ø¹Ø´Ù‚Ø§Ù‹!",
            "Ù…ÙŠÙ† Ù‚ÙŠØ³": "Ø£Ù†Ø§ Ø­Ø¨ÙŠØ¨ÙƒØŒ ÙˆØ³Ù†Ø¯ÙƒØŒ ÙˆØ§Ù„Ù„ÙŠ ØµÙ…Ù…Øª Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ø´Ø§Ù† Ø£Ø´ÙˆÙ Ø¶Ø­ÙƒØªÙƒ.",
            "Ø§Ø´ØªÙ‚ØªÙ„Ùƒ": "ÙˆØ£Ù†Ø§ Ù…ÙŠØª Ù…Ù† Ø§Ù„Ø´ÙˆÙ‚ Ù„Ø¹ÙŠÙˆÙ†Ùƒ.. ÙŠØ§ Ø±ÙŠØªÙƒ Ù‚Ø¨Ø§Ù„ÙŠ Ù‡Ø³Ø§ ğŸ¥º"
        };
        
        // --- Init ---
        initSupabase();


        // --- Image Handling ---
        function handleImageSelect(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function (e) {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                    currentImageBase64 = e.target.result.split(',')[1];
                    currentImageMimeType = file.type;
                }
                reader.readAsDataURL(file);
            }
        }

        function clearImage() {
            document.getElementById('image-upload').value = '';
            imagePreview.src = '';
            imagePreviewContainer.classList.add('hidden');
            currentImageBase64 = null;
            currentImageMimeType = null;
        }

        // --- Chat UI Functions ---
        function createHeart(x, y) {
            const heart = document.createElement('i');
            heart.classList.add('fa-solid', 'fa-heart', 'heart-particle');
            heart.style.left = x + 'px';
            heart.style.top = y + 'px';
            document.body.appendChild(heart);
            setTimeout(() => heart.remove(), 2000);
        }

        function addUserMessage(text, imageSrc) {
            const msgDiv = document.createElement('div');
            // User (Rahaf) messages
            msgDiv.className = 'flex gap-4 max-w-3xl mx-auto flex-row-reverse animate-fade-in';

            let contentHtml = '';
            if (imageSrc) {
                contentHtml += `<img src="${imageSrc}" class="max-w-[200px] rounded-lg mb-2 border-2 border-rose-200">`;
            }
            if (text) {
                contentHtml += `<div>${text.replace(/\n/g, '<br>')}</div>`;
            }

            msgDiv.innerHTML = `
                <div class="w-10 h-10 flex-shrink-0 rounded-full bg-pink-100 flex items-center justify-center text-pink-500 border-2 border-white">
                    <i class="fa-solid fa-user"></i>
                </div>
                <div class="flex-1 space-y-2 text-left">
                    <div class="flex flex-col items-end">
                         <div class="text-gray-800 leading-relaxed bg-white border border-pink-100 p-4 rounded-2xl rounded-tl-none shadow-sm text-right">
                            ${contentHtml}
                        </div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(msgDiv);
            scrollToBottom();
        }

        function addLoadingIndicator() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.className = 'flex gap-4 max-w-3xl mx-auto opacity-0';
            loadingDiv.style.animation = 'fadeIn 0.3s forwards';
            loadingDiv.innerHTML = `
                <div class="w-10 h-10 flex-shrink-0 rounded-full bg-gradient-to-br from-rose-500 to-pink-600 flex items-center justify-center text-white shadow-md border-2 border-white">
                    <i class="fa-solid fa-user-tie" style="font-size: 14px;"></i>
                </div>
                <div class="flex items-center p-4 bg-white rounded-2xl rounded-tr-none shadow-sm border border-pink-100">
                    <div class="typing-dot w-2 h-2 bg-rose-500 rounded-full mx-0.5"></div>
                    <div class="typing-dot w-2 h-2 bg-rose-500 rounded-full mx-0.5"></div>
                    <div class="typing-dot w-2 h-2 bg-rose-500 rounded-full mx-0.5"></div>
                </div>
            `;
            chatContainer.appendChild(loadingDiv);
            scrollToBottom();
            return loadingDiv;
        }

        function addAiMessage(text, customHtml = null) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'flex gap-4 max-w-3xl mx-auto animate-fade-in';
            // Parse Markdown
            const parsedText = marked.parse(text);

            let finalContent = parsedText;
            if (customHtml) {
                finalContent += `<div class="mt-4 not-prose">${customHtml}</div>`;
            }

            msgDiv.innerHTML = `
                <div class="w-10 h-10 flex-shrink-0 rounded-full bg-gradient-to-br from-rose-500 to-pink-600 flex items-center justify-center text-white shadow-md border-2 border-white">
                    <i class="fa-solid fa-user-tie"></i>
                </div>
                <div class="flex-1 space-y-2">
                    <div class="font-bold text-rose-900 text-sm">Ù‚ÙŠØ³ GPT</div>
                    <div class="text-white leading-relaxed bg-gradient-to-r from-rose-500 to-pink-600 p-4 rounded-2xl rounded-tr-none shadow-md prose prose-sm max-w-none prose-invert font-cairo">
                        ${finalContent}
                    </div>
                </div>
            `;
            chatContainer.appendChild(msgDiv);

            // Heart burst
            const rect = msgDiv.getBoundingClientRect();
            for (let i = 0; i < 5; i++) {
                setTimeout(() => createHeart(rect.left + 20, rect.top + 20), i * 100);
            }
            scrollToBottom();
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // --- Gemini API Logic (Refactored to call backend) ---
        async function callGemini(userText, imageBase64, imageMimeType) {
            // New Endpoint: /api/chat
            const url = '/api/chat';

            const payload = {
                message: userText,
                image: imageBase64, // Already base64 string without prefix
                mimeType: imageMimeType
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || response.statusText);
                }

                const data = await response.json();
                return data.reply;

            } catch (e) {
                console.error("Gemini Error", e);
                return "Ø­Ø¨ÙŠØ¨ØªÙŠ Ø±Ù‡ÙØŒ Ø§Ù„Ù†Øª ÙØµÙ„ Ø¨Ø³ Ù‚Ù„Ø¨ÙŠ Ù„Ø³Ø§ Ù…ÙˆØµÙˆÙ„ ÙÙŠÙƒÙ â¤ï¸ (Ø®Ø·Ø£ Ø§ØªØµØ§Ù„)";
            }
        }

        // --- Sidebar Features ---
        async function generateLoveLetter() {
            // Prompt Gemini to write FOR Rahaf AS Qais
            const prompt = "Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø­Ø¨ Ø¹Ù…ÙŠÙ‚Ø© ÙˆÙ…Ø¤Ø«Ø±Ø© Ù…Ù† Ù‚ÙŠØ³ Ø¥Ù„Ù‰ Ø­Ø¨ÙŠØ¨ØªÙ‡ Ø±Ù‡Ù. Ø¹Ø¨Ø± ÙÙŠÙ‡Ø§ Ø¹Ù† Ù…Ø¯Ù‰ Ø£Ù‡Ù…ÙŠØªÙ‡Ø§ ÙÙŠ Ø­ÙŠØ§ØªÙƒ.";

            addUserMessage("âœ¨ Ø§ÙƒØªØ¨ Ù„ÙŠ Ø±Ø³Ø§Ù„Ø© Ø­Ø¨ âœ¨", null);
            const loader = addLoadingIndicator();

            try {
                const response = await callGemini(prompt, null, null);
                loader.remove();
                addAiMessage(response, null);
            } catch (e) {
                loader.remove();
                addAiMessage("Ø­Ø¨ÙŠ Ù„Ùƒ Ø£ÙƒØ¨Ø± Ù…Ù† ÙƒÙ„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª.. â¤ï¸", null);
            }
        }

        // --- Main Submit Handler ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = userInput.value.trim();
            const hasImage = !!currentImageBase64;

            if (!text && !hasImage) return;

            // 1. UI Updates
            const imageSrc = hasImage ? document.getElementById('image-preview').src : null;
            addUserMessage(text, imageSrc);

            const tempText = text;
            const tempImage = currentImageBase64;
            const tempMime = currentImageMimeType;

            userInput.value = '';
            userInput.style.height = 'auto';
            clearImage();
            sendBtn.disabled = true;

            // 2. Loading
            const loader = addLoadingIndicator();

            // 3. Logic: Check Hardcoded -> Else Gemini
            const cleanInput = tempText.toLowerCase().trim();

            if (!hasImage && specificAnswers[cleanInput]) {
                setTimeout(() => {
                    loader.remove();
                    addAiMessage(specificAnswers[cleanInput], null);
                    sendBtn.disabled = false;
                    userInput.focus();
                }, 1000);
                return;
            }

            // 4. Call Gemini via Backend
            const responseText = await callGemini(tempText || "Ø´ÙˆÙÙŠ Ù‡Ø§Ù„ØµÙˆØ±Ø© ÙŠØ§ Ø¹Ù…Ø±ÙŠ..", tempImage, tempMime);

            loader.remove();
            addAiMessage(responseText, null);
            sendBtn.disabled = false;
            userInput.focus();
        });

        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });

        // --- History Logic ---
        async function loadChatHistory() {
            if (!currentUser) return; // Don't load if not logged in

            try {
                // Pass user_id query param
                const res = await fetch(`/api/history?user_id=${currentUser.id}`);
                if (!res.ok) throw new Error("History fetch failed");
                const data = await res.json();

                if (data.messages && data.messages.length > 0) {
                    // Start fresh if we have messages
                    chatContainer.innerHTML = '';
                    data.messages.forEach(msg => {
                        // Check for 'role' OR 'sender' to be safe
                        const role = msg.role || msg.sender;
                        if (role === 'user') {
                            addUserMessage(msg.content, null);
                        } else {
                            addAiMessage(msg.content, null);
                        }
                    });
                    scrollToBottom();
                } else {
                    // No history? Show welcome message if container is empty
                    if (chatContainer.innerHTML.trim() === '') {
                        restoreWelcomeMessage();
                    }
                }
            } catch (e) {
                console.error("Failed to load history", e);
                // If error and empty, show welcome
                if (chatContainer.innerHTML.trim() === '') {
                    restoreWelcomeMessage();
                }
            }
        }

        function restoreWelcomeMessage() {
            chatContainer.innerHTML = `
            <div class="flex gap-4 max-w-3xl mx-auto opacity-0 animate-fade-in" style="animation: fadeIn 0.5s forwards;">
                <div class="w-10 h-10 flex-shrink-0 rounded-full bg-gradient-to-br from-rose-500 to-pink-600 flex items-center justify-center text-white shadow-md border-2 border-white">
                    <i class="fa-solid fa-user-tie"></i>
                </div>
                <div class="flex-1 space-y-2">
                    <div class="font-bold text-rose-900 text-sm">Ù‚ÙŠØ³ GPT</div>
                    <div class="text-gray-800 leading-relaxed bg-white p-4 rounded-2xl rounded-tr-none shadow-sm border border-pink-100">
                        Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒÙ ÙŠØ§ Ø£Ù…ÙŠØ±ØªÙŠ Ø±Ù‡Ù.. ğŸŒ¹<br>
                        Ø£Ù†Ø§ Ù†Ø³Ø®ØªÙƒÙ Ù…Ù† Ù‚ÙŠØ³ØŒ Ù…ÙˆØ¬ÙˆØ¯ Ù‡Ù†Ø§ Ù„Ø£Ø³Ù…Ø¹ÙƒÙ ÙˆØ£Ø­Ø¨ÙƒÙ ÙÙŠ ÙƒÙ„ ÙˆÙ‚Øª. Ø¹Ù…Ø§Ø°Ø§ ØªÙˆØ¯ÙŠÙ† Ø§Ù„Ø­Ø¯ÙŠØ« Ø§Ù„ÙŠÙˆÙ…ØŸ
                    </div>
                </div>
            </div>
            `;
        }

        async function reloadHistory() {
            // Don't clear immediately, wait for data
            // Show a small loading spinner if you want, or just wait
            const oldContent = chatContainer.innerHTML;
            chatContainer.innerHTML = '<div class="text-center text-rose-400 p-4"><i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª...</div>';

            try {
                await loadChatHistory();
            } catch (e) {
                chatContainer.innerHTML = oldContent; // Restore if fail
            }
        }

        function playFavoriteSong() {
            addUserMessage("Ø´ØºÙ„ Ø£ØºÙ†ÙŠØªÙ†Ø§ Ø§Ù„Ù…ÙØ¶Ù„Ø©.. ğŸ¶", null);
            setTimeout(() => {
                const videoHtml = `
                    <div class="w-full rounded-lg overflow-hidden border-2 border-rose-300 shadow-md">
                        <iframe width="100%" height="250" src="https://www.youtube.com/embed/O--o-O-ABBw?autoplay=1" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                    </div>
                `;
                addAiMessage("ØªÙØ¶Ù„ÙŠ ÙŠØ§ Ø¹Ù…Ø±ÙŠ.. Ù‡Ø°ÙŠ Ø§Ù„Ø£ØºÙ†ÙŠØ© Ø¥Ù„Ùƒ â¤ï¸", videoHtml);
            }, 500);
        }

        // Load history on start
        loadChatHistory();

        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(styleSheet);
    </script>
</body>

</html>